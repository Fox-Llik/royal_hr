# Generated by Django 4.0.5 on 2022-12-06 14:21

from django.db import migrations
from org.help.roles import default_roles


class Migration(migrations.Migration):

    def _insert_roles(apps, schema):
        Roles = apps.get_model("core", 'Roles')
        Permissions = apps.get_model("core", 'Permissions')
        perms = Permissions.objects.all()

        for role in default_roles:
            perms = role['permissions'].split(",")
            perm_ids = list()
            for perm in perms:
                perm = perm.strip()
                if perm:
                    _filter = {}
                    if "-" in perm:
                        _filter["name"] = perm
                    else:
                        _filter["name__endswith"] = perm
                    fperm_ids = list(Permissions.objects.filter(name__endswith=perm).values_list("id", flat=True))
                    perm_ids = perm_ids + fperm_ids
            role, created = Roles.objects.get_or_create(name=role['name'], defaults={'description': role['description']})
            if created:
                role.permissions.set(perm_ids)

    dependencies = [
        ('core', '0009_auto_20221206_1420'),
    ]

    operations = [
        migrations.RunPython(_insert_roles)
    ]
