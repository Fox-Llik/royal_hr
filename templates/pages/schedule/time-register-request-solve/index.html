{% extends 'base.html' %}

{% load static %}

{% block vendorcss %}
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/forms/select/select2.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/dataTables.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/responsive.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/buttons.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/rowGroup.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/pickers/pickadate/pickadate.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/pickers/flatpickr/flatpickr.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/jkanban/jkanban.min.css' %}">
{% endblock vendorcss %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/components.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/form-validation.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/pickers/form-flat-pickr.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/pickers/form-pickadate.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/fonts/font-awesome/css/font-awesome.min.css' %}" />
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Inconsolata&amp;family=Roboto+Slab&amp;family=Slabo+27px&amp;family=Sofia&amp;family=Ubuntu+Mono&amp;display=swap">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/pages/app-kanban.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/schedule.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'assets/css/loader.css' %}" />
{% endblock css %}

{% block content %}
<div class="content-body">
    <div class="row" id="table-hover-row">
        <div class="col-12">
            <div>
                <ul class="nav nav-pills mb-2">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home" aria-selected="true">
                            <span class="fw-bold fs-11">
                                <i data-feather='clipboard'></i>
                                Хүсэлт илгээсэн
                            </span>
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">
                            <span class="fw-bold fs-11">
                                <i data-feather='check-square'></i>
                                Шийдэгдсэн
                            </span>
                        </a>
                    </li>
                </ul>
                <div class="tab-content" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title">Хүсэлтүүд</h6>
                            </div>
                            <div class="table-responsive">
                                <div class="card-datatable table-responsive pt-0" id="request_loader_main_display">
                                    <table id="time-request-table" class="time-request-table table text-center">
                                        <thead class="table-light">
                                            <tr class="filter-container"></tr>
                                            <tr>
                                                <th>ID</th>
                                                <th>Нэр</th>
                                                <th>Огноо</th>
                                                <th>Чөлөөний мэдээлэл</th>
                                                <th>Он сар</th>
                                                <th>Үйлдэл</th>
                                            </tr>
                                        </thead>
                                        <tfoot class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Нэр</th>
                                                <th>Огноо</th>
                                                <th>Чөлөөний мэдээлэл</th>
                                                <th>Он сар</th>
                                                <th>Үйлдэл</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title">Шийдэгдсэн хүсэлтүүд</h6>
                            </div>
                            <div class="table-responsive">
                                <div class="card-datatable table-responsive pt-0" id="request_loader_resolved_main_display">
                                    <div class="custom-cell">
                                        <table id="time-end-request-table" class="time-end-request-table table text-center">
                                            <thead class="table-light">
                                                <tr class="filter-container"></tr>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Нэр</th>
                                                    <th>Огноо</th>
                                                    <th>Чөлөөний мэдээлэл</th>
                                                    <th>Он сар</th>
                                                    <th>Үйлдэл</th>
                                                </tr>
                                            </thead>
                                            <tfoot>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Нэр</th>
                                                    <th>Огноо</th>
                                                    <th>Чөлөөний мэдээлэл</th>
                                                    <th>Он сар</th>
                                                    <th>Үйлдэл</th>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{% include "pages/schedule/time-register-request-solve/modal/time-request-request-description.html" with id="modalDescription" %}
{% include "pages/schedule/time-register-request-solve/modal/user_info_detail.html" with id="modalUserDescription" %}
{% include "pages/schedule/time-register-request-solve/modal/reason_for.html" with id="reasonFor" %}
{% include "pages/schedule/time-register-request-solve/modal/reason_for_rejection.html" with id="reasonForRejection" %}
{% include "pages/main/warning-modal.html" %}

{% endblock content %}

{% block js %}

<script src="{% static 'app-assets/vendors/js/forms/select/select2.full.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.bootstrap5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/responsive.bootstrap5.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/datatables.buttons.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/jszip.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/pdfmake.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/vfs_fonts.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/buttons.html5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/buttons.print.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.rowGroup.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/forms/cleave/cleave.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/forms/cleave/addons/cleave-phone.us.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/flatpickr/flatpickr.min.js' %}"></script>

<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.date.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.time.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/legacy.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/flatpickr/flatpickr.min.js' %}"></script>

<script src="{% static 'app-assets/js/scripts/pages/app-user-list.js' %}"></script>

<script src="{% static 'app-assets/js/scripts/tables/table-datatables-advanced.js' %}"></script>
<script src="{% static 'app-assets/js/scripts/forms/pickers/form-pickers.js' %}"></script>

<script>
    /** Tooltip */
	$(document).ready(function() {
        $("body").tooltip({ selector: '[data-toggle=tooltip]' });
    });

    /** үндсэн хуудасны loader арилгана */
    let loaderTurnOffMain = function()
    {
        document.getElementById('loader-request-employee').classList.remove('loaderWew')
        document.getElementById('request_loader_display').style.display = 'none'
        document.getElementById('request_loader_main_display').style.display = 'block'
    }

    /** Header дээр input ийг clone хийж гаргах нь */
	cloneFooter('.time-request-table', [ 1, 2 ])
    /** DATATABLE */
	const dataTable = $(".time-request-table")
        .on('preXhr.dt', function ()
        {
            addLoader($('#request_loader_main_display'))
        })
        .on( 'draw.dt', function () {
            rmLoader($('#request_loader_main_display'))
        })
        .DataTable({
            processing: false,
            dom: 'lBfrtip',
            serverSide: true,
            ajax: { url: `{% url 'time-register-request-waiting-json' %}` },
            columns: [
                { data: "id" },
                { data: "first_name" },
                { data: "created_at" },
                { data: "vacation_type" },
                { data: "created_at" },
                { data: "description" },
            ],
            bFilter: true,
            columnDefs: [
                {
                    targets: 0,
                    title: "#",
                    orderable: false,
                    render: function (data, type, full, meta) {
                        return (
                            meta.settings._iDisplayStart + meta.row + 1
                        );
                    },
                },
                {
                    targets: 1,
                    render: function (data, type, full, meta) {

                        let lastName = full.employee.user.user_info.last_name[0]
                        let firstName = full.employee.user.user_info.first_name
                        let fullName = ''
                        if (lastName)
                        {
                            fullName = lastName + '.'
                        }
                        fullName = fullName + firstName

                        let user_data = JSON.stringify(full.employee)

                        return (
                            `<u>
                                <a
                                    class="name-text-hover"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalUserDescription"
                                    onclick='userDetailFunction(
                                        ${user_data}
                                    )'
                                >
                                    ${fullName}
                                </a>
                            </u>
                            `
                        )
                    },
                },
                {
                    targets: 3,
                    render: function (data, type, full, meta) {
                        if (!full.vacation_type || full.vacation_type == 'None')
                        {
                            return ('-')
                        }
                        return (
                            full.vacation_type
                        );
                    },
                },
                {
                    targets: 4,
                    orderable: true,
                    render: function (data, type, full, meta)
                    {
                        let date_value = full.start_day
                        if(full.end_day)
                        {
                            date_value = date_value.concat(' - ', full.end_day)
                        }
                        if(full.start_time)
                        {
                            date_value = date_value.concat('  ', full.start_time)
                        }
                        if(full.end_time)
                        {
                            date_value = date_value.concat(' - ', full.end_time)
                        }
                        return  date_value
                    },
                },
                {
                    targets: 5,
                    orderable: false,
                    render: function (data, type, full, meta)
                    {
                        /** null гэсэн хоосон утгыг утгагүй string болгоно */
                        if (!full.description) {
                            full.description = ''
                        }

                        let allData = JSON.stringify(full)

                        return (
                            `
                            ${
                                full.is_need_answer
                                ?
                                `<a
                                    data-toggle="tooltip"
                                    title="Зөвшөөрөх"
                                    {% if 'request-solve-agree' not in request.permissions %}
                                        data-bs-toggle="modal"
                                        data-bs-target="#warning-modal"
                                    {% endif %}
                                    {% if 'request-solve-agree' in request.permissions %}
                                        onclick="agreeRequest(${full.id}, ${full.vacation_type})"
                                    {% endif %}
                                    class="text-success delete-record"
                                >
                                    ${feather.icons["check"].toSvg(
                                    {
                                        class: "font-small-4",
                                    })}
                                </a>
                                <a
                                    data-toggle="tooltip"
                                    title="Татгалзах"
                                    data-bs-toggle='modal'
                                    data-bs-target="{% if 'request-solve-refuse' in request.permissions %} #reasonForRejection {% else %} #warning-modal {% endif %}"
                                    class="text-danger delete-record ms-1"
                                    onclick="changeRequestId(${full.id}, ${full.vacation_type})"
                                >
                                    ${feather.icons["x"].toSvg(
                                    {
                                        class: "font-small-4",
                                    })}
                                </a>`
                                :
                                ''
                            }

                            <a
                                data-toggle='tooltip'
                                title='Тайлбар'
                                data-bs-toggle='modal'
                                data-bs-target='#modalDescription'
                                class='text-secondary delete-record ms-1'
                                onclick='descriptionFunction(
                                    ${allData}
                                )'
                            >
                                ${feather.icons["info"].toSvg(
                                {
                                    class: "font-small-4",
                                })}
                            </a>

                            <a
                                data-toggle='tooltip'
                                title='Хэвлэх'
                                href='/schedule/time-register-request-print/${full.id}'
                                class='text-info delete-record ms-1'
                                target='_blank'
                            >
                                ${feather.icons["printer"].toSvg(
                                {
                                    class: "font-small-4",
                                })}
                            </a>`
                        )
                    }
                },
            ],
            order: [[1, "desc"]],
            lengthMenu: [
                [10, 25, 50, 100, -1],
                [10, 25, 50, 100, 'Бүгд'],
            ],
            dom:
                '<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"' +
                '<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l>' +
                '<"col-sm-12 col-lg-8 ps-xl-75 ps-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1">B>>' +
                ">t" +
                '<"d-flex justify-content-between mx-2 row mb-1"' +
                '<"col-sm-12 col-md-6"i>' +
                '<"col-sm-12 col-md-6"p>' +
                ">",
            oLanguage: {
                sProcessing: "Ачааллаж байна. ",
                sSearch: "Хайх: ",
                sEmptyTable: "Бичлэг байхгүй",
                sInfoEmpty: "Нийт 0 бичлэг",
                sInfo: "Дэлгэцэнд: _START_ - _END_ Нийт: _TOTAL_ бичлэг",
                sInfoFiltered: " - _MAX_ бичлэгээс",
                sLengthMenu: "_MENU_ бичлэг",
                oPaginate: {
                    sFirst: "Эхэнд",
                    sLast: "Төгсгөлд",
                    sNext: "Дараах",
                    sPrevious: "Өмнөх",
                },
            },
            // Buttons with Dropdown
            buttons: [
                {
                    extend: "collection",
                    className: "btn btn-outline-secondary dropdown-toggle me-2",
                    text:
                        feather.icons["external-link"].toSvg({
                            class: "font-small-4 me-50",
                        }) + "Export",
                    buttons: [
                        {
                            extend: "print",
                            text:
                                feather.icons["printer"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Print",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2, 3, 4] },
                        },
                        {
                            extend: "csv",
                            text:
                                feather.icons["file-text"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Csv",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2, 3, 4] },
                        },
                        {
                            extend: "excel",
                            text:
                                feather.icons["file"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Excel",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2, 3, 4] },
                        },
                        {
                            extend: "pdf",
                            text:
                                feather.icons["clipboard"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Pdf",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2, 3, 4] },
                        },
                        {
                            extend: "copy",
                            text:
                                feather.icons["copy"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Copy",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2, 3, 4] },
                        },
                    ],
                    init: function (api, node, config) {
                        $(node).removeClass("btn-secondary");
                        $(node).parent().removeClass("btn-group");
                        setTimeout(function () {
                            $(node)
                                .closest(".dt-buttons")
                                .removeClass("btn-group")
                                .addClass("d-inline-flex mt-50");
                        }, 50);
                    },
                },
            ],
        });
    searchFooter(dataTable)

    /** үндсэн хуудасны loader арилгана */
    let loaderTurnOffResolvedMain = function()
    {
        document.getElementById('loader-request-resolved-employee').classList.remove('loaderWew')
        document.getElementById('request_loader_resolved_display').style.display = 'none'
        document.getElementById('request_loader_resolved_main_display').style.display = 'block'
    }

    /** Шийдэгдсэн хүсэлтийн Datatable */
    /** Footer дээр input ийг clone хийж гаргах нь */
    cloneFooter(
        ".time-end-request-table",
        [
            1
        ]
    )
    /** DATATABLE */
    const dataEndTable = $(".time-end-request-table")
    .on('preXhr.dt', function ()
    {
        addLoader($('#request_loader_resolved_main_display'))
    })
    .on( 'draw.dt', function () {
        rmLoader($('#request_loader_resolved_main_display'))
    })
    .DataTable({
        processing: false,
        dom: 'lBfrtip',
        serverSide: true,
        ajax: { url: `{% url 'time-register-request-ended-json' %}` },
        columns: [
            { data: "id" },
            { data: "first_name" },
            { data: "created_at" },
            { data: "vacation_type" },
            { data: "created_at" },
            { data: "description" },
        ],
        bFilter: true,
        columnDefs: [
            {
                targets: 0,
                title: "#",
                orderable: false,
                render: function (data, type, full, meta) {
                    if (full.status == 2)
                    {
                        meta.settings.aoData[meta.row].nTr.className = meta.settings.aoData[meta.row].nTr.className + " red-decline-border "
                    }

                    if (full.status == 3)
                    {
                        meta.settings.aoData[meta.row].nTr.className = meta.settings.aoData[meta.row].nTr.className + " green-agree-border "
                    }
                    return (
                        meta.settings._iDisplayStart + meta.row + 1
                    );
                },
            },
            {
                targets: 1,
                render: function (data, type, full, meta) {

                    let lastName = full.employee.user.user_info.last_name[0]
                    let firstName = full.employee.user.user_info.first_name
                    let fullName = ''
                    if (lastName)
                    {
                        fullName = lastName + '.'
                    }
                    fullName = fullName + firstName

                    let user_data = JSON.stringify(full.employee)

                    return (
                        `<u>
                            <a
                                class="name-text-hover"
                                data-bs-toggle="modal"
                                data-bs-target="#modalUserDescription"
                                onclick='userDetailFunction(
                                    ${user_data}
                                )'
                            >
                                ${fullName}
                            </a>
                        <u>
                        `
                    )
                },
            },
            {
                targets: 3,
                render: function (data, type, full, meta) {
                    if (!full.vacation_type || full.vacation_type == 'None')
                    {
                        return ('-')
                    }
                    return (
                        full.vacation_type
                    );
                },
            },
            {
                targets: 4,
                orderable: true,
                render: function (data, type, full, meta)
                {
                    let date_value = full.start_day
                    if(full.end_day)
                    {
                        date_value = date_value.concat(' - ', full.end_day)
                    }
                    if(full.start_time)
                    {
                        date_value = date_value.concat('  ', full.start_time)
                    }
                    if(full.end_time)
                    {
                        date_value = date_value.concat(' - ', full.end_time)
                    }
                    return  date_value
                },
            },
            {
                targets: 5,
                orderable: false,
                render: function (data, type, full, meta)
                {

                    let allData = JSON.stringify(full)

                    /** null гэсэн хоосон утгыг утгагүй string болгоно */
                    if (!full.description) {
                        full.description = ''
                    }
                    return (
                        `<a
                            data-toggle='tooltip'
                            title='Тайлбар'
                            data-bs-toggle='modal'
                            data-bs-target='#modalDescription'
                            class='text-secondary delete-record ms-1'
                            onclick='descriptionFunction(
                                ${allData}
                            )'
                        >
                            ${feather.icons["info"].toSvg(
                            {
                                class: "font-small-4",
                            })}
                        </a>` +
                        (
                            full.status == 3
                            ?
                                `<a
                                    data-toggle="tooltip"
                                    title="Зөвшөөрсөн"
                                    data-bs-toggle="modal"
                                    data-bs-target="#reasonFor"
                                    onclick='reasonFunction(
                                        ${allData}
                                    )'
                                    class="text-success delete-record ms-1"
                                >
                                    ${feather.icons["clipboard"].toSvg(
                                    {
                                        class: "font-small-4",
                                    })}
                                </a><span style="display: none;">Зөвшөөрсөн</span>`
                            :
                                `<a
                                    data-toggle="tooltip"
                                    title="Татгалзсан шалтгаан"
                                    data-bs-toggle="modal"
                                    data-bs-target="#reasonFor"
                                    class="text-danger delete-record ms-1"
                                    onclick='reasonFunction(
                                        ${allData}
                                    )'
                                >
                                    ${feather.icons["clipboard"].toSvg(
                                    {
                                        class: "font-small-4",
                                    })}
                                </a><span style="display: none;">Татгалзсан</span>`
                        )
                    )
                }
            },
        ],
        order: [[1, "desc"]],
        lengthMenu: [
            [10, 25, 50, 100, -1],
            [10, 25, 50, 100, 'Бүгд'],
        ],
        dom:
            '<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"' +
            '<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l>' +
            '<"col-sm-12 col-lg-8 ps-xl-75 ps-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1">B>>' +
            ">t" +
            '<"d-flex justify-content-between mx-2 row mb-1"' +
            '<"col-sm-12 col-md-6"i>' +
            '<"col-sm-12 col-md-6"p>' +
            ">",
        oLanguage: {
            sProcessing: "Ачааллаж байна. ",
            sSearch: "Хайх: ",
            sEmptyTable: "Бичлэг байхгүй",
            sInfoEmpty: "Нийт 0 бичлэг",
            sInfo: "Дэлгэцэнд: _START_ - _END_ Нийт: _TOTAL_ бичлэг",
            sInfoFiltered: " - _MAX_ бичлэгээс",
            sLengthMenu: "_MENU_ бичлэг",
            oPaginate: {
                sFirst: "Эхэнд",
                sLast: "Төгсгөлд",
                sNext: "Дараах",
                sPrevious: "Өмнөх",
            },
        },
        // Buttons with Dropdown
        buttons: [
            {
                extend: "collection",
                className: "btn btn-outline-secondary dropdown-toggle me-2",
                text:
                    feather.icons["external-link"].toSvg({
                        class: "font-small-4 me-50",
                    }) + "Export",
                buttons: [
                    {
                        extend: "print",
                        text:
                            feather.icons["printer"].toSvg({
                                class: "font-small-4 me-50",
                            }) + "Print",
                        className: "dropdown-item",
                        exportOptions: { columns: [0, 1, 2, 3, 4, 5] },
                    },
                    {
                        extend: "csv",
                        text:
                            feather.icons["file-text"].toSvg({
                                class: "font-small-4 me-50",
                            }) + "Csv",
                        className: "dropdown-item",
                        exportOptions: { columns: [0, 1, 2, 3, 4, 5] },
                    },
                    {
                        extend: "excel",
                        text:
                            feather.icons["file"].toSvg({
                                class: "font-small-4 me-50",
                            }) + "Excel",
                        className: "dropdown-item",
                        exportOptions: { columns: [0, 1, 2, 3, 4, 5] },
                    },
                    {
                        extend: "pdf",
                        text:
                            feather.icons["clipboard"].toSvg({
                                class: "font-small-4 me-50",
                            }) + "Pdf",
                        className: "dropdown-item",
                        exportOptions: { columns: [0, 1, 2, 3, 4, 5] },
                    },
                    {
                        extend: "copy",
                        text:
                            feather.icons["copy"].toSvg({
                                class: "font-small-4 me-50",
                            }) + "Copy",
                        className: "dropdown-item",
                        exportOptions: { columns: [0, 1, 2, 3, 4, 5] },
                    },
                ],
                init: function (api, node, config) {
                    $(node).removeClass("btn-secondary");
                    $(node).parent().removeClass("btn-group");
                    setTimeout(function () {
                        $(node)
                            .closest(".dt-buttons")
                            .removeClass("btn-group")
                            .addClass("d-inline-flex mt-50");
                    }, 50);
                },
            },
        ],
    });
    searchFooter(dataEndTable)

</script>

<script>

    let table_detail = document.getElementById("detail_table").getElementsByTagName('tbody')[0];

    /** Тайлбарын модалд утгыг онооно */
    async function descriptionFunction(detailData)
    {
        let status = ''
		if (detailData.status == 2)
		{
			status = 'Татгалзсан'
		}
		else if (detailData.status == 3)
		{
			status = 'Зөвшөөрсөн'
		}
		else
		{
			status = 'Хүлээгдэж буй'
		}

		let last_value = detailData.start_day
		if(detailData.end_day)
		{
			last_value = last_value.concat(' - ', detailData.end_day)
		}
		if(detailData.start_time)
		{
			last_value = last_value.concat('  ', detailData.start_time)
		}
		if(detailData.end_time)
		{
			last_value = last_value.concat(' - ', detailData.end_time)
		}

		document.getElementById('title_reason_agreed_detail').textContent = status
		document.getElementById('reason_date_detail').textContent = detailData.created_at
		document.getElementById('reason_request_date_detail').textContent = last_value
		document.getElementById('description_detail').textContent = detailData.description

		const { data, success, errors } = await fetchData(`/schedule/time-register-request-org-pos/${detailData.vacation_type}/${detailData.id}/`, null, 'GET')

        $("#detail_table tbody tr").remove();
        if(success)
        {
			data.map((val, idx) =>
			{
				let row = table_detail.insertRow(-1);

				let c1 = row.insertCell(0);
				let c2 = row.insertCell(1);
				let c3 = row.insertCell(2);
				let c4 = row.insertCell(2);

				c1.innerText = idx + 1
				c2.innerText = val?.org_position.name
				c3.innerHTML = val?.answers ? val?.answers?.message : ''
				c4.innerHTML = val?.answers ? val?.answers?.is_confirm ? '<span style="color: #5fff53;" >зөвшөөрсөн</span>' : '<span style="color: #ff5353;" >татгалзсан</span>' : 'хүлээгдэж буй'
			})
        }
    }

    /** Шалтгааны модалд утгыг онооно */
    async function reasonFunction(data)
    {
        /** Нэрний формат */
        let lastName = data.agreed.user.user_info.last_name[0]
        let firstName = data.agreed.user.user_info.first_name
        let fullName = ''
        if (lastName)
        {
            fullName = lastName + '.'
        }
        fullName = fullName + firstName

        document.getElementById('reason_agreed').textContent = fullName
        document.getElementById('reason_date').textContent = data.resolved_date

        /** Татгалзсан бол шалтгаан байгаа үгүйг шалгана */
        if (data.status == 3)
        {
            document.getElementById('reason_reason').style.display = 'none'
            document.getElementById('title_reason_agreed').textContent = 'Зөвшөөрсөн'
        }
        else
        {
            document.getElementById('reason_reason').style.display = 'block'
            document.getElementById('reason_text').textContent = data.reason_for_rejection
            document.getElementById('title_reason_agreed').textContent = 'Татгалзсан'
        }
    }

    let dataTableUser
    let userDetailLoader = document.getElementById('loaderuid-employee')
    let userDetailLoaderText = document.getElementById('user_loader_display').style
    let userLoaderText = document.getElementById('user_main_loader_display').style

    /** Тус хэрэглэгчийн loader арилгана */
    let loaderTurnOff = function()
    {
        userDetailLoader.classList.remove('loaderWew')
        userDetailLoaderText.display = 'none'
        userLoaderText.display = 'block'
    }

    /** Footer дээр input ийг clone хийж гаргах нь */
    cloneFooter(
        ".time-request-user-table",
        [
            1
        ]
    )

    /** Сонгосон хэрэглэгчийн дэлгэрэнгүй мэдээлэл */
    async function userDetailFunction(data)
    {
        userDetailLoader.classList.add('loaderWew')
        userDetailLoaderText.display = 'block'
        userLoaderText.display = 'none'

        /** Нэрийг оноож байна */
        let lastName = data.user.user_info.last_name
        let firstName = data.user.user_info.first_name
        let fullName = ''
        if (lastName)
        {
            fullName = lastName + ' '
        }
        fullName = fullName + firstName
        document.getElementById('realName').textContent = fullName

        let mail = ''
        let phoneNumber = ''
        let address = ''
        let position = ''
        let org = ''

        /** DATATABLE-уудаа устгаад дахиад ачааллуулна */
        if (dataTableUser)
        {
            dataTableUser.destroy()
        }

        /** MAIL */
        let orgDetailHref = document.getElementById('orgDetailHref')

        if(data.user.email)
        {
            mail = data.user.email
        }
        orgDetailHref.textContent = data.user.email

        /** PHONE */
        if(data.user.phone_number)
        {
            phoneNumber = data.user.phone_number
        }
        document.getElementById('phoneDetail').textContent = phoneNumber

        /** ADDRESS */
        if(data.user.user_info.address)
        {
            address = data.user.user_info.address
        }
        document.getElementById('addressDetail').textContent = address

        /** ORGS */
        if(data.org)
        {
            org = data.org.name
        }
        document.getElementById('orgDetail').textContent = org

        /** POSITION */
        if(data.sub_org)
        {
            position = position + data.sub_org.name + ' - '
        }
        if(data.salbar)
        {
            position = position + data.salbar.name + ' - '
        }
        if(data.org_position)
        {
            position = position + data.org_position.name
        }
        document.getElementById('positionDetail').textContent = position

        /** DATATABLE */
        dataTableUser = await $(".time-request-user-table")
        .on('preXhr.dt', function ()
		{
			addLoader($('#time-request-user-table-loader'))
		})
		.on( 'draw.dt', function () {
			rmLoader($('#time-request-user-table-loader'))
        })
        .DataTable({
            processing: false,
            dom: 'lBfrtip',
            serverSide: true,
            ajax: {
                url: `{% url 'time-register-request-user-waiting-json' %}`,
                type: 'GET',
                data: { 'employeeId': data.id }
            },
            columns: [
                { data: "id" },
                { data: "created_at" },
                { data: "vacation_type" },
                { data: "created_at" },
                { data: "description" },
            ],
            initComplete: function()
            {
                loaderTurnOff()
            },
            bFilter: true,
            columnDefs: [
                {
                    targets: 0,
                    title: "#",
                    orderable: false,
                    render: function (data, type, full, meta) {

                        if (full.status == 2)
                        {
                            meta.settings.aoData[meta.row].nTr.className = meta.settings.aoData[meta.row].nTr.className + " red-decline-border "
                        }

                        if (full.status == 3)
                        {
                            meta.settings.aoData[meta.row].nTr.className = meta.settings.aoData[meta.row].nTr.className + " green-agree-border "
                        }

                        return (
                            meta.settings._iDisplayStart + meta.row + 1
                        );
                    },
                },
                {
                    targets: 2,
                    orderable: false,
                    render: function (data, type, full, meta) {
                        if (!full.vacation_type || full.vacation_type == 'None')
                        {
                            return ('-')
                        }
                        return (
                            full.vacation_type
                        );
                    },
                },
                {
                    targets: 3,
                    orderable: false,
                    render: function (data, type, full, meta)
                    {
                        let date_value = full.start_day
                        if(full.end_day)
                        {
                            date_value = date_value.concat(' - ', full.end_day)
                        }
                        if(full.start_time)
                        {
                            date_value = date_value.concat('  ', full.start_time)
                        }
                        if(full.end_time)
                        {
                            date_value = date_value.concat(' - ', full.end_time)
                        }
                        return  date_value
                    },
                },
                {
                    targets: 4,
                    orderable: false
                },
            ],
            order: [[1, "desc"]],
            lengthMenu: [
                [10, 25, 50, 100, -1],
                [10, 25, 50, 100, 'Бүгд'],
            ],
            dom:
                '<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"' +
                '<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l>' +
                '<"col-sm-12 col-lg-8 ps-xl-75 ps-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1">B>>' +
                ">t" +
                '<"d-flex justify-content-between mx-2 row mb-1"' +
                '<"col-sm-12 col-md-6"i>' +
                '<"col-sm-12 col-md-6"p>' +
                ">",
            oLanguage: {
                sProcessing: "Ачааллаж байна. ",
                sSearch: "Хайх: ",
                sEmptyTable: "Хүсэлт илгээж байгаагүй.",
                sInfoEmpty: "Нийт 0 бичлэг",
                sInfo: "Дэлгэцэнд: _START_ - _END_ Нийт: _TOTAL_ бичлэг",
                sInfoFiltered: " - _MAX_ бичлэгээс",
                sLengthMenu: "_MENU_ бичлэг",
                oPaginate: {
                    sFirst: "Эхэнд",
                    sLast: "Төгсгөлд",
                    sNext: "Дараах",
                    sPrevious: "Өмнөх",
                },
            },
            // Buttons with Dropdown
            buttons: [
                {
                    extend: "collection",
                    className: "btn btn-outline-secondary dropdown-toggle me-2",
                    text:
                        feather.icons["external-link"].toSvg({
                            class: "font-small-4 me-50",
                        }) + "Export",
                    buttons: [
                        {
                            extend: "print",
                            text:
                                feather.icons["printer"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Print",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2, 3, 4] },
                        },
                        {
                            extend: "csv",
                            text:
                                feather.icons["file-text"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Csv",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2, 3, 4] },
                        },
                        {
                            extend: "excel",
                            text:
                                feather.icons["file"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Excel",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2, 3, 4] },
                        },
                        {
                            extend: "pdf",
                            text:
                                feather.icons["clipboard"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Pdf",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2, 3, 4] },
                        },
                        {
                            extend: "copy",
                            text:
                                feather.icons["copy"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Copy",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2, 3, 4] },
                        },
                    ],
                    init: function (api, node, config) {
                        $(node).removeClass("btn-secondary");
                        $(node).parent().removeClass("btn-group");
                        setTimeout(function () {
                            $(node)
                                .closest(".dt-buttons")
                                .removeClass("btn-group")
                                .addClass("d-inline-flex mt-50");
                        }, 50);
                    },
                }
            ],
        });
        searchFooter(dataTableUser)
    }

    /** Зөвшөөрөх үйлдэл */
    async function agreeRequest(id, vacation_id)
    {
        addLoader($('#request_loader_resolved_main_display'))
        addLoader($('#request_loader_main_display'))
        const { success } = await fetchData(`/schedule/time-register-request-org-pos-agree/${id}/?vacation=${vacation_id}`, null, 'PUT')

        /** Амжилттай болбол Datatable-г дахин ачааллуулж байна */
        if (success)
        {
            dataTable.ajax.reload(null, false)
            dataEndTable.ajax.reload(null, false)
        }
    }

    var declineRequestId
    var declineVacationId

    /** Идэвхжүүлсэн татгалзах ID-г хадгална */
    function changeRequestId(id, vacation_id)
    {
        declineRequestId = id
        declineVacationId = vacation_id
        document.getElementById('reason_for_rejection').value = ''
    }

    /** Татгалзах үйлдэл */
    async function declineRequest(event)
    {
        event.preventDefault();

        const formData = new FormData(event.target)
        const data = Object.fromEntries(formData)

        addLoader($('#request_loader_resolved_main_display'))
        addLoader($('#request_loader_main_display'))

        // useLoader(fetchData(`/schedule/time-register-request-decline/${declineRequestId}/`, data, 'PUT'), $('#reason-for-rejection-loader')).catch(err => err)
        useLoader(fetchData(`/schedule/time-register-request-org-pos-decline/${declineRequestId}/?vacation=${declineVacationId}`, data, 'PUT'), $('#reason-for-rejection-loader')).catch(err => err)
            .then(
                ({ success, data, errors }) =>
                {
                    /** Амжилттай болбол Datatable-г дахин ачааллуулж байна */
                    if (success)
                    {
                        dataTable.ajax.reload(null, false)
                        dataEndTable.ajax.reload(null, false)
                        setTimeout(function()
                        {
                            document.querySelector("#rfr_close_btn").click()
                        },
                        300)
                    }
                }
            )
    }

</script>

{% endblock js %}
