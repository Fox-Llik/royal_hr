{% extends 'base.html' %}
<!--prettier-ignore-->
{% load static %}
<!--prettier-ignore-->
{% block content %}

{% load rest_framework %}

{% block css %}

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/schedule.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/vendors.min.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/dataTables.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/responsive.bootstrap5.min.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/dataTables.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/responsive.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/buttons.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/rowGroup.bootstrap5.min.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/pickers/form-flat-pickr.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/pickers/form-pickadate.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/pickers/pickadate/pickadate.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/pickers/flatpickr/flatpickr.min.css' %}">

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/components.css' %}" />


<link rel="stylesheet" type="text/css" href="{% static 'app-assets/fonts/font-awesome/css/font-awesome.min.css' %}" />
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">
<link rel="stylesheet" type="text/css" href="{% static 'assets/css/loader.css' %}" />

{% endblock css %}

<div class="content-body">
    <div class="row" id="table-hover-row">
        <div class="col-12">
            <div>
                <ul class="nav nav-pills">

                    <li class="nav-item ms-1">
                        <a
                        class="btn btn-secondary waves-effect waves-float waves-light w-100"
                        data-bs-toggle="modal"
                        data-bs-target="#choose-employee"
                    ><i style="margin-right: 5px;" data-feather='file-plus'></i>Ажилчин сонгох</a>
                    </li>
                    <li class="nav-item ms-1">
                        <h6 class="card-border-version2" id="chosedDateId"></h6>
                    </li>
                    <li class="nav-item ms-1">
                        <h6 class="card-border-version2" id="chosedEmployeeName"></h6>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-12">
            <div>
                <form id="trrForm" onsubmit="clickBtn(event)" >
                    <div class="row ms-1">
                        <div class="col-12 col-sm-6 col-md-3 mb-1 position-relative">
                            <label class="form-label" for="date">Он сар *</label>
                            <input type="text" id="date" name="date" class="form-control year-and-month" placeholder="2000-01" data-msg="Он сараа оруулна уу"/>
                        </div>
                        <div class="col-12 col-sm-12 col-md-2">
                            <button class="btn btn-primary waves-effect waves-float waves-light mt-2 w-100"><i style="margin-right: 5px;" data-feather='search'></i>Хайх</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row" id="table-small">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Үнэлгээ оруулах</h4>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" id="assessment-table">
                        <thead>
                            <tr class="filter-container"></tr>
                            <tr>
                                <th></th>
                                <th>#</th>
                                <th>Оноо</th>
                                <th>Тайлбар</th>
                                <th>Үйлдэл</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th></th>
                                <th>#</th>
                                <th>Оноо</th>
                                <th>Тайлбар</th>
                                <th>Үйлдэл</th>
                            </tr>
                        </tfoot>
                        <!-- <tbody style="font-size: 12px;"></tbody> -->
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Form -->
{% include "pages/kpi/give-an-assessment/form.html" %}

<!-- Model -->
{% include "pages/kpi/give-an-assessment/modal/choose-employee.html" with id="choose-employee" %}
{% include "pages/kpi/give-an-assessment/modal/delete.html" with id="userReward" deletebtn="deletebtn" %}

{% endblock content %}

{% block js %}

<script src="{% static 'app-assets/vendors/js/tables/datatable/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.bootstrap5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/responsive.bootstrap5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/flatpickr/flatpickr.min.js' %}"></script>

<script src="{% static 'app-assets/vendors/js/tables/datatable/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.bootstrap5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/responsive.bootstrap5.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/datatables.buttons.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/jszip.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/pdfmake.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/vfs_fonts.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/buttons.html5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/buttons.print.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.rowGroup.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/forms/cleave/cleave.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/forms/cleave/addons/cleave-phone.us.js' %}"></script>

<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.date.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.time.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/legacy.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/flatpickr/flatpickr.min.js' %}"></script>

<script src="{% static 'app-assets/js/scripts/pages/app-user-list.js' %}"></script>

<script src="{% static 'app-assets/js/scripts/tables/table-datatables-advanced.js' %}"></script>
<script src="{% static 'app-assets/js/scripts/forms/pickers/form-pickers.js' %}"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/3.5.0/select2.min.js"></script>

<script src="{% static 'app-assets/vendors/js/forms/repeater/jquery.repeater.min.js' %}"></script>
<script src="{% static 'app-assets/js/scripts/forms/form-repeater.js' %}"></script>

<script>

    var dateObj = new Date();

    /** 1 => 01 болгох Format */
    const zeroFill = n =>
    {
        return ('0' + n).slice(-2);
    }

    var choserDateInput = document.getElementById('chosedDateId')
    var chosedEmployeeNameInput = document.getElementById('chosedEmployeeName')

    /** Сонгогдсн ажилчны ID-г хадгалана */
    var chosedEmployeesId = "{{employee_id}}"
    var chosedEmployeesName = '{{employee_full_name}}'
    var mainDatatableData = { date: null }

    chosedEmployeeNameInput.innerHTML = chosedEmployeesName

    /** Ажилчин нэмэх хэсэг */
    cloneFooter(
        "#kpi-assessment-employee-table",
        [
            1, 2, 3
        ]
    )
    const reportChooseEmployee = $("#kpi-assessment-employee-table")
        .on('preXhr.dt', function ()
        {
            addLoader($('#kpi-assessment-employee-table-loader'))
        })
        .on( 'draw.dt', function () {
            rmLoader($('#kpi-assessment-employee-table-loader'))
        })
        .DataTable({
            processing: false,
            dom: 'lBfrtip',
            serverSide: true,
            ajax: { url: `{% url 'time-register-report-employee-json' %}` },
            columns: [
                // columns according to JSON
                { data: "id" },
                { data: "last_name" },
                { data: "first_name" },
                { data: "register" },
            ],
            bFilter: true,
            initComplete: function()
            {
                // loaderTurnOff()
            },
            columnDefs: [
                {
                    targets: 0,
                    title: "#",
                    orderable:false,
                    render: function (data, type, full, meta)
                    {

                        let employeeId = full.id

                        if (full.id === parseInt(chosedEmployeesId))
                        {
                            meta.settings.aoData[meta.row].nTr.className = meta.settings.aoData[meta.row].nTr.className + ' datatable-row-bg '
                        }
                        else
                        {
                            meta.settings.aoData[meta.row].nTr.className = meta.settings.aoData[meta.row].nTr.className + ' datatable-row-hover '

                            meta.settings.aoData[meta.row].nTr.onclick = async function(event)
                            {

                                chosedEmployeesId = employeeId

                                let thisMonthValue = new Date(dateObj.getFullYear(), dateObj.getMonth())
                                choserDateInput.innerHTML = `${thisMonthValue.getFullYear()} оны ${thisMonthValue.getMonth() + 1}-р сар`

                                const { data } = await fetchData(`/kpi/get-employee-name/${chosedEmployeesId}/`, null, 'GET')
                                chosedEmployeeNameInput.innerHTML = data

                                mainDatatableData.date = `${thisMonthValue.getFullYear()}-${thisMonthValue.getMonth() + 1}`
                                document.getElementById('date').value = ''
                                document.getElementsByClassName('this-date')[0].style.display = 'inline'
                                document.getElementById('employee').value = chosedEmployeesId

                                kpiAssessmentDatatable.ajax.url(`{% url 'assessment-employee-json' %}${chosedEmployeesId}?date=${thisMonthValue.getFullYear()}-${thisMonthValue.getMonth()}`).load()
                                $('#choose-employee').modal("hide")
                            }
                        }

                        return (
                            meta.settings._iDisplayStart + meta.row + 1
                        )
                    }
                },
                {
                    targets: 1,
                    title: "Овог",
                    render: function (data, type, full, meta) {
                        return data ? data : "-";
                    },
                },
                {
                    targets: 2,
                    title: "Нэр",
                    render: function (data, type, full, meta) {
                        return data ? data : "-";
                    },
                },
                {
                    targets: 3,
                    render: function (data, type, full, meta) {
                        return data ? data : "-";
                    },
                },
            ],
            order: [[2, "desc"]],
            lengthMenu: [
                [10, 25, 50, 100, -1],
                [10, 25, 50, 100, 'Бүгд'],
            ],
            dom:
                '<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"' +
                '<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l>' +
                '<"col-sm-12 col-lg-8 ps-xl-75 ps-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1">B>>' +
                ">t" +
                '<"d-flex justify-content-between mx-2 row mb-1"' +
                '<"col-sm-12 col-md-6"i>' +
                '<"col-sm-12 col-md-6"p>' +
                ">",
            oLanguage: {
                sProcessing: "Ачааллаж байна. ",
                sSearch: "Хайх: ",
                sEmptyTable: "Бичлэг байхгүй",
                sInfoEmpty: "Нийт 0 бичлэг",
                sInfo: "Дэлгэцэнд: _START_ - _END_ Нийт: _TOTAL_ бичлэг",
                sInfoFiltered: " - _MAX_ бичлэгээс",
                sLengthMenu: "_MENU_ бичлэг",
                oPaginate: {
                    sFirst: "Эхэнд",
                    sLast: "Төгсгөлд",
                    sNext: "Дараах",
                    sPrevious: "Өмнөх",
                },
            },
            // Buttons with Dropdown
            buttons: [
                {
                    extend: "collection",
                    className: "btn btn-outline-secondary dropdown-toggle me-2",
                    text:
                        feather.icons["external-link"].toSvg({
                            class: "font-small-4 me-50",
                        }) + "Export",
                    buttons: [
                        {
                            extend: "print",
                            text:
                                feather.icons["printer"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Print",
                            className: "dropdown-item",
                            exportOptions: { columns: [1, 2, 3, 4, 5] },
                        },
                        {
                            extend: "csv",
                            text:
                                feather.icons["file-text"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Csv",
                            className: "dropdown-item",
                            exportOptions: { columns: [1, 2, 3, 4, 5] },
                        },
                        {
                            extend: "excel",
                            text:
                                feather.icons["file"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Excel",
                            className: "dropdown-item",
                            exportOptions: { columns: [1, 2, 3, 4, 5] },
                        },
                        {
                            extend: "pdf",
                            text:
                                feather.icons["clipboard"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Pdf",
                            className: "dropdown-item",
                            exportOptions: { columns: [1, 2, 3, 4, 5] },
                        },
                        {
                            extend: "copy",
                            text:
                                feather.icons["copy"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Copy",
                            className: "dropdown-item",
                            exportOptions: { columns: [1, 2, 3, 4, 5] },
                        },
                    ],
                },
            ],
        });
    searchFooter(reportChooseEmployee)

    function thisMonth()
    {
        let thisMonthDateValue = new Date(dateObj.getFullYear(), dateObj.getMonth())
        choserDateInput.innerHTML = `${thisMonthDateValue.getFullYear()} оны ${thisMonthDateValue.getMonth() + 1}-р сар`

        mainDatatableData.date = `${thisMonthDateValue.getFullYear()}-${thisMonthDateValue.getMonth() + 1}`

    }
    thisMonth()

    /** Ажилчин нэмэх хэсэг */
    cloneFooter(
        "#assessment-table",
        []
    )

    const kpiAssessmentDatatable = $("#assessment-table")
        .DataTable({
            processing: false,
            dom: 'lBfrtip',
            serverSide: true,
            ajax: {
                url: `{% url 'assessment-employee-json' %}${chosedEmployeesId}/?date=${mainDatatableData.date}`,
                method: 'get',
            },
            columns: [
                // columns according to JSON
                { data: "" },
                { data: "id" },
                { data: "onoo" },
                { data: "tailbar" },
                { data: "" },
            ],
            bFilter: true,
            initComplete: function()
            {
                // loaderTurnOff()
            },
            columnDefs: [
                {
					// Actions
					targets: -1,
					title: "Үйлдэл",
					orderable: false,
					render: function (data, type, full, meta)
					{

						var url = `{% url 'work-time-type' %}`
						return (
							`<a
								data-toggle="tooltip"
								title="Засах"
								onclick="kpiAssessmentUpdate(${full.id})"
								class="text-primary delete-record"
							>` +
							feather.icons["edit-3"].toSvg(
							{
								class: "font-small-4 me-50",
							}) +
							"</a>" +
							`<a
								data-toggle="tooltip"
								title="Устгах"
								data-bs-toggle="modal"
								data-bs-target="{% if 'work-time-type-delete' in request.permissions %} #userReward {% else %} #warning-modal {% endif %}"
								onclick=(changeChoosedId(function(){deleteAssessmentkpi(${full.id})}))
								class="text-primary-orange delete-record mt-1"
							>` +
							feather.icons["trash-2"].toSvg(
							{
								class: "font-small-4 me-50",
							}) +
							"</a>"
						);
					},
				},
                {
                    targets: 1,
                    title: "#",
                    orderable:false,
                    render: function (data, type, full, meta)
                    {
                        return (
                            meta.settings._iDisplayStart + meta.row + 1
                        )
                    }
                },
                {
                    targets: [0, 1, 2, 3, 4],
                    orderable: false
                },
                {
                    targets: 0,
                    width: '1%',
                    render: function (data, type, full, meta)
                    {
                        return ''
                    }
                }
            ],
            order: [[2, "desc"]],
            lengthMenu: [
                [10, 25, 50, 100, -1],
                [10, 25, 50, 100, 'Бүгд'],
            ],
            dom:
                '<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"' +
                '<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l>' +
                '<"col-sm-12 col-lg-8 ps-xl-75 ps-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1">B>>' +
                ">t" +
                '<"d-flex justify-content-between mx-2 row mb-1"' +
                '<"col-sm-12 col-md-6"i>' +
                '<"col-sm-12 col-md-6"p>' +
                ">",
            oLanguage: {
                sProcessing: "Ачааллаж байна. ",
                sSearch: "Хайх: ",
                sEmptyTable: "Бичлэг байхгүй",
                sInfoEmpty: "Нийт 0 бичлэг",
                sInfo: "Дэлгэцэнд: _START_ - _END_ Нийт: _TOTAL_ бичлэг",
                sInfoFiltered: " - _MAX_ бичлэгээс",
                sLengthMenu: "_MENU_ бичлэг",
                oPaginate: {
                    sFirst: "Эхэнд",
                    sLast: "Төгсгөлд",
                    sNext: "Дараах",
                    sPrevious: "Өмнөх",
                },
            },
            // Buttons with Dropdown
            buttons: [
                {
                    extend: "collection",
                    className: "btn btn-outline-secondary dropdown-toggle me-2",
                    text:
                        feather.icons["external-link"].toSvg({
                            class: "font-small-4 me-50",
                        }) + "Export",
                    buttons: [
                        {
                            extend: "print",
                            text:
                                feather.icons["printer"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Print",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2] },
                        },
                        {
                            extend: "csv",
                            text:
                                feather.icons["file-text"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Csv",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2] },
                        },
                        {
                            extend: "excel",
                            text:
                                feather.icons["file"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Excel",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2] },
                        },
                        {
                            extend: "pdf",
                            text:
                                feather.icons["clipboard"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Pdf",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2] },
                        },
                        {
                            extend: "copy",
                            text:
                                feather.icons["copy"].toSvg({
                                    class: "font-small-4 me-50",
                                }) + "Copy",
                            className: "dropdown-item",
                            exportOptions: { columns: [0, 1, 2] },
                        },
                    ],
                },
                {
					text: "Шинээр бүртгэх",
					className: `add-new btn btn-primary this-date`,
					attr: {
						"data-bs-toggle": "modal",
						"data-bs-target": "{% if 'work-time-type-create' in request.permissions %} #modals-slide-in {% else %} #warning-modal {% endif %}",
						"onClick": "clearFormDatas()"
					},
					init: function (api, node, config) {
						$(node).removeClass("btn-secondary").addClass('click_btn')

					},
				},
            ],
        });
    searchFooter(kpiAssessmentDatatable)

</script>

<script>

    async function kpiAssessmentSubmit(event)
    {

        /** Хуудас refresh хийлгэхгүй */
        event.preventDefault()

        /** Хэрэгтэй модалуудын утгуудыг л авна  */
        const formData = new FormData(event.target)
        const data = Object.fromEntries(formData)

        /** Хэрвээ ID-тай байвал POST биш шинэчлэхгэж байгааг мэдээд утгуудаа авч хадгална */
        if(document.getElementById('id').value)
        {
			/** csrfmiddlewaretoken устгаж байна */
            delete data.csrfmiddlewaretoken;

			/** Хүсэлтээ шидэж байна */
            useLoader(fetchData(`/kpi/assessment-ajax/${document.getElementById('id').value}/`, data, 'PUT'), $(event.target)).catch(err => err)
				.then(
					({ success, data, errors }) =>
					{
						/** Амжилттай болбол Datatable refresh хийж modal-ийг хаана */
						if (success)
						{
							setTimeout(function()
							{
								document.querySelector(".btn-close").click()
							},
							300)
							kpiAssessmentDatatable.ajax.reload()
						}
					}
				)
		}
        else
        {
            /** Хүсэлтээ шидэж байна */
            useLoader(fetchData(`/kpi/assessment-ajax/`, data, 'POST'), $(event.target)).catch(err => err)
				.then(
					({ success, data, errors }) =>
					{
						/** Амжилттай болбол Datatable refresh хийж modal-ийг хаана */
						if (success)
						{
							setTimeout(function()
							{
								document.querySelector(".btn-close").click()
							},
							300)
							kpiAssessmentDatatable.ajax.reload()
						}
					}
				)
        }
    }

    /** Form цэвэрлэх */
	function clearFormDatas()
	{
		document.getElementById("id").value = ''
		document.getElementById("onoo").value = ''
		document.getElementById("tailbar").value = ''
	}

    /** Устгах үйлдэл */
    async function deleteAssessmentkpi(choosedId)
    {
		addLoader($('#app-user-list'))
        const { success } = await fetchData(`/kpi/assessment-ajax/${choosedId}/`, null, 'DELETE')
        if (success)
        {
            kpiAssessmentDatatable.ajax.reload(null, false)
        }
    }

    /** Шинэчлэх */
	async function kpiAssessmentUpdate(chosedId)
	{
		/** SideModal нээнэ */
        // document.querySelector(".click_btn").click()
        $("#modals-slide-in").modal("show")

		const { data } = await fetchData(`/kpi/assessment-ajax/${chosedId}/`, null, 'GET')

		if (data)
		{
			document.getElementById("id").value = data.id
			document.getElementById("onoo").value = data.onoo
			document.getElementById("tailbar").value = data.tailbar
		}
	}

    function clickBtn(event)
    {
        event.preventDefault()

        /** Хэрэгтэй модалуудын утгуудыг л авна  */
		const formData = new FormData(event.target)
		const data = Object.fromEntries(formData);

        let thisMonthDateValue = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1)

        if (data.date == `${thisMonthDateValue.getFullYear()}-${thisMonthDateValue.getMonth()}`)
        {
            document.getElementsByClassName('this-date')[0].style.display = 'inline'
        }
        else
        {
            document.getElementsByClassName('this-date')[0].style.display = 'none'
        }

        kpiAssessmentDatatable.ajax.url(`{% url 'assessment-employee-json' %}${chosedEmployeesId}?date=${data.date}`).load()

        choserDateInput.innerHTML = `${data.date.substring(0, 4)} оны ${data.date.substring(5, 7)}-р сар`
    }

</script>

{% endblock js %}
