{% extends 'base.html' %}
{% load mytags %}
<!--prettier-ignore-->
{% load static %}
<!--prettier-ignore-->
{% block content %}

{% block css %}

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/vendors.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/file-uploaders/dropzone.min.css' %}">

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/form-file-uploader.min.css' %}">

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/dataTables.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/responsive.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/buttons.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/rowGroup.bootstrap5.min.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/pickers/form-flat-pickr.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/pickers/form-pickadate.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/pickers/pickadate/pickadate.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/pickers/flatpickr/flatpickr.min.css' %}">

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/components.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/fonts/font-awesome/css/font-awesome.min.css' %}" />
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/jkanban/jkanban.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/pages/app-kanban.css' %}">

{% endblock css %}

<div class="content-body">
    <div class="row" id="table-hover-row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Тушаал, шийдвэр бүртгэх</h4>
                </div>
                <div class="table-responsive">
                    <div class="card-datatable table-responsive pt-0">
                        <table class="command-list-table table text-center">
                            <thead class="table-light">
                                <tr class="filter-container"></tr>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th>Дугаар</th>
                                    <th>Нэр</th>
                                    <th>Хамрах хүрээ</th>
                                    <th>Тайлбар</th>
                                    <th>Тушаалын огноо</th>
                                    <th>Бүртгэгдсэн огноо</th>
                                    <th>Үйлдэл</th>
                                </tr>
                            </thead>
                            <tfoot class="table-light">
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th>Дугаар</th>
                                    <th>Нэр</th>
                                    <th>Хамрах хүрээ</th>
                                    <th>Тайлбар</th>
                                    <th>Тушаалын огноо</th>
                                    <th>Бүртгэгдсэн огноо</th>
                                    <th>Үйлдэл</th>
                                </tr>
                            </tfoot>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal modal-slide-in new-user-modal fade" id="command-create-modal">
                    <div class="modal-dialog">
                        {% include 'pages/command/modal/command-create.html' %}
                    </div>
                </div>
                {% include 'tools/modal/attach-modal.html' %}
                {% include 'pages/command/modal/command-info.html' %}
            </div>
        </div>
    </div>
    <div class="modal fade" id="warning-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered modal-edit-user">
            <div class="modal-content">
                <div class="modal-header bg-transparent">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="text-center">
                        <i class="fas fa-exclamation-circle text-warning fs-40"></i>
                    </div>
                    <h6 class="mt-1 mb-1 fw-bolder">Анхааруулга<h6>
                    Та устгахдаа итгэлтэй байна уу
                </div>
                <div class="modal-footer">
                    <button
                        class="btn btn-primary"
                        data-bs-dismiss="modal"
                        type="button"
                        onclick="deleteOneDonate(event)"
                    >
                        <span>Тийм</span>
                    </button>
                    <button
                        class="btn btn-outline-secondary"
                        data-bs-dismiss="modal"
                    >
                        Үгүй
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block js %}

<script src="{% static 'app-assets/vendors/js/file-uploaders/dropzone.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.bootstrap5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/responsive.bootstrap5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/datatables.buttons.min.js' %}"></script>

<script src="{% static 'app-assets/vendors/js/tables/datatable/jszip.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/pdfmake.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/vfs_fonts.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/buttons.html5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/buttons.print.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.rowGroup.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/forms/cleave/cleave.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/forms/cleave/addons/cleave-phone.us.js' %}"></script>

<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.date.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.time.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/legacy.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/flatpickr/flatpickr.min.js' %}"></script>

<script src="{% static 'app-assets/js/scripts/tables/table-datatables-advanced.js' %}"></script>
<script src="{% static 'app-assets/js/scripts/forms/pickers/form-pickers.js' %}"></script>

<script>

    $(document).ready(function() {
        $("body").tooltip({ selector: '[data-toggle=tooltip]' })
    })

    var selectedEditId = null                           // өөрчлөх хүсэлтэй тушаалын id хадгалах хувьсагч
    let modal = $("#command-create-modal")
    let modalTitle = $("#command-create-modal-title")
    let modalBtn = $("#commandSubmitBtn")
    let modalId = $("#command-create-modal-id")         //тушаал үүсгэх modal
    var commandJqFrom = $('#command-create')            //тушаал үүсгэх form
    var valudateCreate
    var removeFiles = []                                //  арилгасан файлууд зөвхөн засах үед
    let _basicPickr  = $(".flat-basic")
    let basic = _basicPickr.flatpickr()
    var multipleFiles = $("#dZUpload")
    var commandInfoTable = null
    var warningModal = $("#warning-modal")
    var tableBtn = []
    var ajaxTableUrl = 'self'
    var is_perm = `{% if request.permissions|has_perm:'command-update, command-delete, command-create' %}true{% else %}false{% endif %}`
    var tableText = 'Төлөв: Нийт'

    if (is_perm === 'true')
    {
        $('#slipSearchBtn').show()
        ajaxTableUrl = 'all'
        tableBtn.push(
            {
            extend: "",
            text: "Нийт",
            className: "dropdown-item",
            exportOptions: { columns: [1, 2, 3, 4, 5, 6, 7] },
                action: function(e, slipTable, node, config) {
                    const dropDownBtn = $('#slipSearchBtn')
                    dropDownBtn.trigger("click")
                    dotoodState = 'all'
                    dropDownBtn.html('Төлөв: Нийт')
                    slipTable.ajax.url(`/command/list/all/`).load()
                    ajaxTableUrl = 'all'
                },
            },
            {
            extend: "",
            text: "Өөрт хамааралтай",
            className: "dropdown-item",
            exportOptions: { columns: [1, 2, 3, 4, 5, 6, 7] },
                action: function(e, slipTable, node, config) {
                    const dropDownBtn = $('#slipSearchBtn')
                    dropDownBtn.trigger("click")
                    dotoodState = 'self'
                    dropDownBtn.html('Төлөв: Өөрт хамааралтай')
                    slipTable.ajax.url(`/command/list/self/`).load()
                    ajaxTableUrl = 'self'
                },
            },
        )
    }

    cloneFooter(
        ".command-list-table",
        [
            2, 3, 4, 5, 6, 7
        ]
    )

    const commandTable = $(".command-list-table").DataTable({
        fixedColumns:   {
            left: 0,
            right: 1
        },
        processing: false,
        dom: 'lBfrtip',
        serverSide: true,
        ajax: { url: `/command/list/${ajaxTableUrl}/` }, // JSON file to add data
        columns: [
            // columns according to JSON
            { data: null },
            { data: null },
            { data: "command_number" },
            { data: "name" },
            { data: "unit_name" },
            { data: "description" },
            { data: "date" },
            { data: "formated_created_at" },
            { data: null },
        ],
        columnDefs: [
            {
                // For Responsive
                className: "control",
                orderable: false,
                responsivePriority: 2,
                targets: 0,
                render: function (data, type, full, meta) {
                    return ""
                },
            },
            {
                // Actions
                targets: -1,
                title: "Үйлдэл",
                orderable: false,
                render: function (data, type, full, meta) {
                    if (is_perm === 'true')
                    {
                        return (
                            `
                                <a
                                    class="delete-record text-primary"
                                    onclick="handleEditModal(event)"
                                >
                                    <span
                                        data-bs-toggle="tooltip" title="Харах, устгах" data-bs-placement="left" data-bs-original-title="Сургалт засах"
                                    >
                                        ${feather.icons["edit-3"].toSvg({
                                            class: "font-small-4 me-50",
                                        })}
                                    </span>
                                </a>
                                <a
                                    class="delete-record text-info"
                                    onclick="getAttachmetsList('/command/get-command-attachmets/', ${full.id})"
                                    data-bs-toggle="modal"
                                    data-bs-target="#attachment-modal"
                                >
                                    <span
                                        data-bs-toggle="tooltip" title="Хавсралт татах" data-bs-placement="left" data-bs-original-title="Хавсралт татах"
                                    >
                                        ${feather.icons["download"].toSvg({
                                            class: "font-small-4 me-50",
                                        })}
                                    </span>
                                </a>
                                <a
                                    class="delete-record text-info"
                                    title="Тушаалын явц"
                                    onclick="handleInfoModal(event)"
                                >
                                    ${feather.icons["info"].toSvg({
                                        class: "font-small-4 me-50",
                                    })}
                                </a>
                            `
                        )
                    }
                    else
                    {
                        return (
                            `
                            <a
                                class="delete-record text-info"
                                onclick="getAttachmetsList('/command/get-command-attachmets/', ${full.id})"
                                data-bs-toggle="modal"
                                data-bs-target="#attachment-modal"
                            >
                                <span
                                    data-bs-toggle="tooltip" title="Хавсралт татах" data-bs-placement="left" data-bs-original-title="Хавсралт татах"
                                >
                                    ${feather.icons["download"].toSvg({
                                        class: "font-small-4 me-50",
                                    })}
                                </span>
                            </a>
                            `
                        )
                    }
                },
            },
            {
                targets: 1,
                title: "#",
                orderable: false,
                render: function (data, type, full, meta) {
                    return (
                        meta.settings._iDisplayStart + meta.row + 1
                    )
                },
            },
        ],
        order: [[2, "asc"]],
        lengthMenu: [
			[10, 25, 50, 100, -1],
			[10, 25, 50, 100, 'Бүгд'],
		],
        dom:
            '<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"' +
            '<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l>' +
            '<"col-sm-12 col-lg-8 ps-xl-75 ps-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1">B>>' +
            ">t" +
            '<"d-flex justify-content-between mx-2 row mb-1"' +
            '<"col-sm-12 col-md-6"i>' +
            '<"col-sm-12 col-md-6"p>' +
            ">",
        oLanguage: {
            sProcessing: "Ачааллаж байна. ",
            sSearch: "Хайх: ",
            sEmptyTable: "Бичлэг байхгүй",
            sInfoEmpty: "Нийт 0 бичлэг",
            sInfo: "Дэлгэцэнд: _START_ - _END_ Нийт: _TOTAL_ бичлэг",
            sInfoFiltered: " - _MAX_ бичлэгээс",
            sLengthMenu: "_MENU_ бичлэг",
            oPaginate: {
                sFirst: "Эхэнд",
                sLast: "Төгсгөлд",
                sNext: "Дараах",
                sPrevious: "Өмнөх",
            },
        },
        // Buttons with Dropdown
        buttons: [
            {
				extend: "collection",
				className: "btn btn-outline-secondary flaot-start px-1 me-2 dropdown-toggle custom-a-none",
				text: tableText,
				config: {
					left: 0,
					right: 0
				},
                attr: {
                    "id": "slipSearchBtn",
                    "style": "margin-top: 7px"
                },
                init: function (api, node, config) {
                    if(is_perm == 'true')
                        $(node).show()
                    else
                        $(node).hide()
				},
				buttons: tableBtn
			},
            {
                extend: "collection",
                className: "btn btn-outline-secondary dropdown-toggle me-2",
                text:
                    feather.icons["external-link"].toSvg({
                        class: "font-small-4 me-50",
                    }) + "Export",
                buttons: [
                    {
                        extend: "print",
                        text:
                            feather.icons["printer"].toSvg({
                                class: "font-small-4 me-50",
                            }) + "Print",
                        className: "dropdown-item",
                        exportOptions: { columns: [1, 2, 3, 4, 5, 6, 7] },
                    },
                    {
                        extend: "csv",
                        text:
                            feather.icons["file-text"].toSvg({
                                class: "font-small-4 me-50",
                            }) + "Csv",
                        className: "dropdown-item",
                        exportOptions: { columns: [1, 2, 3, 4, 5, 6, 7] },
                    },
                    {
                        extend: "excel",
                        text:
                            feather.icons["file"].toSvg({
                                class: "font-small-4 me-50",
                            }) + "Excel",
                        className: "dropdown-item",
                        exportOptions: { columns: [1, 2, 3, 4, 5, 6, 7] },
                    },
                    {
                        extend: "pdf",
                        text:
                            feather.icons["clipboard"].toSvg({
                                class: "font-small-4 me-50",
                            }) + "Pdf",
                        className: "dropdown-item",
                        exportOptions: { columns: [1, 2, 3, 4, 5, 6, 7] },
                    },
                    {
                        extend: "copy",
                        text:
                            feather.icons["copy"].toSvg({
                                class: "font-small-4 me-50",
                            }) + "Copy",
                        className: "dropdown-item",
                        exportOptions: { columns: [1, 2, 3, 4, 5, 6, 7] },
                    },
                ],
                init: function (api, node, config) {
                    $(node).removeClass("btn-secondary")
                    $(node).parent().removeClass("btn-group")
                    setTimeout(function () {
                        $(node)
                            .removeClass("btn-group")
                            .addClass("d-inline-flex mt-50")
                    }, 50)
                },
            },
            {
				text: "Шинээр бүртгэх",
				className: "btn btn-primary btn-sm cbtn-height",
				attr: {
                    "id": "create-btn",
					"data-bs-toggle": "modal",
                    "data-bs-target": "#command-create-modal",
                    "onclick": "handleCreateModal()",
				},
				init: function (api, node, config) {
                    if(is_perm == 'true')
                        $(node).show()
                    else
                        $(node).hide()
					$(node).removeClass("btn-secondary")
				},
			},
        ],
    })
    searchFooter(commandTable)

    // validator
    if (commandJqFrom.length) {
        valudateCreate = commandJqFrom.validate({
            rules: {
                "commander": {
                    required: true,
                },
                "unit": {
                    required: true,
                },
                "employees": {
                    required: true,
                },
                "command_number": {
                    required: true,
                },
                "name": {
                    required: true,
                },
                "description": {
                    required: true,
                },
                "date": {
                    required: true,
                },
            },
            messages: {
                'commander': {
                    required: 'Тушаалын баталсан талбарыг бөглөнө үү.',
                },
                'unit': {
                    required: 'Тушаалын хамрах хүрээ талбарыг бөглөнө үү.',
                },
                'employees': {
                    required: 'Ажилтан сонгох талбарыг бөглөнө үү.',
                },
                'command_number': {
                    required: 'Дугаар талбарыг бөглөнө үү.',
                },
                'name': {
                    required: 'Нэр талбарыг бөглөнө үү.',
                },
                'description': {
                    required: 'Тайлбар талбарыг бөглөнө үү.',
                },
                'date': {
                    required: 'Тушаалын огноо талбарыг бөглөнө үү.',
                },
            },
             // Алдааны messsage байрлал өөрчлөх
            errorPlacement: function(error, element) {
                var placement = $(element).data('error')
                if (placement) {
                    $(placement).append(error)
                } else {
                    error.insertAfter(element)
                }
                if (element.parent().hasClass('input-group')) {
                    element.parent().addClass('is-invalid')
                }
            },
            highlight: function (element, errorClass, validClass) {
                $(element).addClass('error')
                if ($(element).parent().hasClass('input-group')) {
                    $(element).parent().addClass('is-invalid')
                }
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).removeClass('error')
                if ($(element).parent().hasClass('input-group')) {
                    $(element).parent().removeClass('is-invalid')
                }
            }
        })
    }

    function handleChangeTypeCommand(event)
    {
        const selectedValue = event.target.value
        var employeeDiv = document.getElementById('employees-div')
        if ( selectedValue === 'selected_employees' )
        {
            $(`#employees`).val('').trigger('change')
            employeeDiv.style.display = 'block'
        }
        else
        {
            employeeDiv.style.display = 'none'
        }
    }

    // Warning model харуулах
    async function deleteOneDonate(event, id)
    {
        const { success, error } = await fetchData(`command-create-delete/${selectedEditId}/`, null, 'DELETE', "", false)

            if(error)
            {
                // input ийг validate алдаа г харуулах
                displayError(error)
            } else {
                // input ийн харагдсан байгаа validate алдаануудыг устгах
                deleteError(error)
            }
            if (success)
            {
                // datatable refresh хийх
                $('#command-create-modal').modal('hide')
                commandTable.ajax.reload(null, false)
            }
    }

    async function saveCommand(event)
	{
		event.preventDefault()

        if(!valudateCreate.checkForm())
        {
            return
        }

        const formData = new FormData(event.target)
        const attachemnts = dz.files.filter(el => !el.cfile)

        for(var i = 0; i < attachemnts.length; i ++) {
            const element = attachemnts[i]
            formData.append("attachments", element, element.name)
        }
        formData.append("removed_attachments", JSON.stringify(removeFiles))


        if (selectedEditId){
            warningModal.modal("show")
        }
        else
        {
            const { success, errors } = await fetchData(`command-create-edit/`, formData, 'POST', "", false)

            if(errors)
            {
                // input ийг validate алдаа г харуулах
                displayError(errors)
            } else {
                // input ийн харагдсан байгаа validate алдаануудыг устгах
                deleteError(errors)
            }
            if (success)
            {
                // datatable refresh хийх
                commandTable.ajax.reload(null, false)
                document.getElementById("command-create").reset()
                $(`#unit`).val('').trigger('change')
                $('#command-create-modal').modal('hide')
            }
        }
	}

    function clearDz()
    {
        dz.files.map(
            (_file, idx) =>
            {
                $(_file.previewElement).remove()
                dz.emit("removefile", _file)
            }
        )

        dz.files = []
        $(".dz-default").show()
    }

    /** Шинээр үүсгэх товч дарж модал нээх үед formийн input цэвэрлэх */
	function handleCreateModal()
	{
		const title = `Тушаал шийдвэрийн бүртгэл`

        $('#commanderDiv').show()
        $('#commander2Div').hide()
        $('#employeesDiv').show()
        $('#employees2Div').hide()
        $('#hawsralt').show()

        $(`#name`).prop("disabled", false)
        $(`#command_number`).prop("disabled", false)
        $(`.form-check-input`).prop("disabled", false)
        $(`.form-check-input`).attr("checked",false)
        $(`#unit_name`).prop("disabled", false)
        $(`#description`).prop("disabled", false)
        $(`#employees`).prop("disabled", false)
        $(`#date`).prop("disabled", false)
        $(`#formated_created_at`).prop("disabled", false)

		modalTitle.text(title)
        document.getElementById("command-create").reset()
        $(`#unit`).val('').trigger('change')
        $(`#employees`).val('').change()
        $(`#commander`).val('').change()

        modalBtn.text('Хадгалах')
        modalBtn.removeClass('btn-danger')
        modalBtn.addClass('btn-primary')

		modalId.text(null)
        selectedEditId = null
        basic.setDate(null)
        clearDz()
        document.getElementById('employees-div').style.display= "none"
        $("#commander").prop("disabled", false)

	}

    //  edit товч дарахад input-үүдийн утгыг оноох нь
    function setData(full)
	{
        selectedEditId = full.id
        let employeeSelect2 = $("#employees2")

        $('#commanderDiv').hide()
        $('#commander2Div').show()
        $('#employeesDiv').hide()
        $('#employees2Div').show()
        $('#hawsralt').hide()
        $(`#name`).val(full.name).change()
        $(`#command_number`).val(full.command_number).change()
        $(`#${full.unit}`).attr("checked",true)
        $(`#unit_div`).val(full.unit).change()
        $(`#unit_name`).val(full.unit_name).change()
        $(`#description`).val(full.description).change()
        $(`#employees`).val(full.employees).change()
        $(`#date`).val(full.date).change()
        $(`#formated_created_at`).val(full.formated_created_at).change()
        basic.setDate(full.date)

        $(`#name`).prop("disabled", true)
        $(`#command_number`).prop("disabled", true)
        $(`.form-check-input`).prop("disabled", true)
        $(`#unit_name`).prop("disabled", true)
        $(`#description`).prop("disabled", true)
        $(`#employees`).prop("disabled", true)
        $(`#date`).prop("disabled", true)
        $(`#formated_created_at`).prop("disabled", true)

        employeeSelect2.empty()
        full.employee_list.map((employee_info)=>
        {
            var newOption = new Option(employee_info.full_name, employee_info.id, true, true)
            employeeSelect2.append(newOption).trigger('change')
        })
        employeeSelect2.prop("disabled", true)

        $("#commander2").empty()
        var data = {
            id: full.commander,
            text: full.commander_name,
        }

        var newOption = new Option(data.text, data.id, false, false)
        $('#commander2').append(newOption).trigger('change')
        $(`#commander2`).val(full.commander).change()
        $("#commander2").prop("disabled", true)
	}

        /** Засах товч дарж модал нээх үед гарчигийг оноох */
	const handleEditModal = async (event) =>
	{

		let clickedTarget = $(event.target)
		let row = clickedTarget.parent().closest("tr")
		let full = commandTable.row(row).data()
        let id = full.id

        modalBtn.text('Устгах')
        modalBtn.removeClass('btn-primary')
        modalBtn.addClass('btn-danger')
		modalTitle.text(`${full.name}`)
		modalId.text(full.id)

        modal.modal('show')
		setData(full)
        clearDz()

        const { success, data } = await fetchData(`command-create-edit/${id}/`, null, 'GET')
        if(success)
        {
            $(".dz-default").show()
            data.attachments.map(
                (el, idx) =>
                {
                    var mockFile = { name: el.name, size: el.pure_size, type: el.mime_type, id: el.id, cfile: true }
                    dz.files.push(mockFile)
                    dz.emit("addedfile", mockFile)
                    dz.emit("thumbnail", mockFile, el.url)
                    dz.emit("success", mockFile)
                    $(".dz-progress").remove()
                    $(".dz-remove").html(
                        `<div><span class='fa fa-trash text-danger'></span></div>`
                    )
                }
            )

            if (data.attachments.length)
            {
                $(".dz-default").remove()
            }
        }

	}

    function handleCreateAgain(data)
    {
        const title = `Тушаал шийдвэрийн бүртгэл`

		modalTitle.text(title)
        document.getElementById("command-create").reset()
        $(`#unit`).val('').trigger('change')
        $(`#employees`).val('').change()
        $(`#commander`).val('').change()
        modalBtn.text('Хадгалах')
		modalId.text(null)
        selectedEditId = null
        basic.setDate(null)
        modal.modal('show')
    }

    Dropzone.autoDiscover = false
    let dz = new Dropzone("#dZUpload", {
        url: "/test",
        clickable: true,
        paramName: 'file', // The name that will be used to transfer the file
        autoProcessQueue: false,
        addRemoveLinks: true,
        accept: function(file, done)
        {
            if (file.size > 1*1024*1024) {
                this.removeFile(file)
                alert('Хэтэрхий том хэмжээтэй байна.')
                return false
            }

            $(".dz-progress").remove()
            $(".dz-remove").html(
                `<div><span class='fa fa-trash text-danger'></span></div>`
            )
            return file.previewElement.classList.add("dz-success")
        },
        removedfile: function(file) {
            //  зөвхөн засаж байгаа үед хуучин байсан зургаас id ийг авна
            file.id && removeFiles.push(file.id)

            $(file.previewElement).remove()
        }
    })

    cloneFooter(
		".command-info-table",
		[
			2, 3, 4, 5
		]
	)
    // Тухайн тушаалын дагуу шийдвэр гүйцэтгүүлсэн ажилчдын жагсаалтыг харуулах
	const handleInfoModal = async(event) =>
	{
		let clickedTarget = $(event.target)
		let row = clickedTarget.parent().closest("tr")
		let full = commandTable.row(row).data()

        $("#command-info-modal").modal("show")

        if (commandInfoTable)
        {
            commandInfoTable.destroy()
        }

		// Тушаалын list table
		commandInfoTable = $(".command-info-table").DataTable({
			fixedColumns:   {
				left: 0,
				right: 1
			},
			processing: true,
			dom: 'lBfrtip',
			retrieve: true,
			serverSide: true,
			select: true,
			ajax: { url: `/worker/employee-migrations-info/${full.id}/` }, // JSON file to add data
			columns: [
				// columns according to JSON
				{ data: null },
				{ data: null },
				{ data: "last_name" },
				{ data: "first_name" },
				{ data: "employee_mood_display" },
				{ data: "updated_at_info" },
			],
			columnDefs: [
				{
					// For Responsive
					className: "control",
					orderable: false,
					responsivePriority: 2,
					targets: 0,
					render: function (data, type, full, meta) {
						return ""
					},
				},
				{
					targets: 1,
					title: "#",
					orderable: false,
					render: function (data, type, full, meta) {
						return (
							meta.settings._iDisplayStart + meta.row + 1
						)
					},
				},
			],
			order: [[2, "asc"]],
            lengthMenu: [
                [10, 25, 50, 100, -1],
                [10, 25, 50, 100, 'Бүгд'],
            ],
			dom:
				'<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"' +
				'<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l>' +
				'<"col-sm-12 col-lg-8 ps-xl-75 ps-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1">B>>' +
				">t" +
				'<"d-flex justify-content-between mx-2 row mb-1"' +
				'<"col-sm-12 col-md-6"i>' +
				'<"col-sm-12 col-md-6"p>' +
				">",
			oLanguage: {
				sProcessing: "Ачааллаж байна. ",
				sSearch: "Хайх: ",
				sEmptyTable: "Бичлэг байхгүй",
				sInfoEmpty: "Нийт 0 бичлэг",
				sInfo: "Дэлгэцэнд: _START_ - _END_ Нийт: _TOTAL_ бичлэг",
				sInfoFiltered: " - _MAX_ бичлэгээс",
				sLengthMenu: "_MENU_ бичлэг",
				oPaginate: {
					sFirst: "Эхэнд",
					sLast: "Төгсгөлд",
					sNext: "Дараах",
					sPrevious: "Өмнөх",
				},
			},
			// Buttons with Dropdown
			buttons: [
				{
					extend: "collection",
					className: "btn btn-outline-secondary dropdown-toggle me-2",
					text:
						feather.icons["external-link"].toSvg({
							class: "font-small-4 me-50",
						}) + "Export",
					buttons: [
						{
							extend: "print",
							text:
								feather.icons["printer"].toSvg({
									class: "font-small-4 me-50",
								}) + "Print",
							className: "dropdown-item",
							exportOptions: { columns: [1, 2, 3, 4, 5] },
						},
						{
							extend: "csv",
							text:
								feather.icons["file-text"].toSvg({
									class: "font-small-4 me-50",
								}) + "Csv",
							className: "dropdown-item",
							exportOptions: { columns: [1, 2, 3, 4, 5] },
						},
						{
							extend: "excel",
							text:
								feather.icons["file"].toSvg({
									class: "font-small-4 me-50",
								}) + "Excel",
							className: "dropdown-item",
							exportOptions: { columns: [1, 2, 3, 4, 5] },
						},
						{
							extend: "pdf",
							text:
								feather.icons["clipboard"].toSvg({
									class: "font-small-4 me-50",
								}) + "Pdf",
							className: "dropdown-item",
							exportOptions: { columns: [1, 2, 3, 4, 5] },
						},
						{
							extend: "copy",
							text:
								feather.icons["copy"].toSvg({
									class: "font-small-4 me-50",
								}) + "Copy",
							className: "dropdown-item",
							exportOptions: { columns: [1, 2, 3, 4, 5] },
						},
					],
					init: function (api, node, config) {
						$(node).removeClass("btn-secondary")
						$(node).parent().removeClass("btn-group")
						setTimeout(function () {
							$(node)
								.removeClass("btn-group")
								.addClass("d-inline-flex mt-50")
						}, 50)
					},
				},
			],
		})
		searchFooter(commandInfoTable)
    }

</script>

{% endblock js %}
