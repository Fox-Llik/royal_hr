{% extends 'base.html' %}
<!--prettier-ignore-->
{% load static %}
<!--prettier-ignore-->
{% block content %}

{% block css %}

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/vendors.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/dataTables.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/responsive.bootstrap5.min.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/dataTables.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/responsive.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/buttons.bootstrap5.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/tables/datatable/rowGroup.bootstrap5.min.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/pickers/form-flat-pickr.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/pickers/form-pickadate.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/file-uploaders/dropzone.min.css' %}">

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/pickers/pickadate/pickadate.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/pickers/flatpickr/flatpickr.min.css' %}">

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/components.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/fonts/font-awesome/css/font-awesome.min.css' %}" />

<link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/jkanban/jkanban.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/pages/app-kanban.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/plugins/forms/form-file-uploader.min.css' %}">

{% endblock css %}

<div class="content-body">
    <div class="row">
        <div class="col-12">
			<div class="card">
				<div class="card-header">
                    <h4 class="card-title">Загвар файл</h4>
					<a class="text-dark fw-bold" href="{% static 'file/zorchil-burtgeh-huudas.doc' %}" download="зөрчил-бүртгэх-хуудас">
						зөрчил-бүртгэх-хуудас.docx
						<i class="text-primary font-small-6" data-feather="arrow-down"></i>
					</a>
                </div>
			</div>
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Зөрчил бүртгэх хуудас бүртгэлүүд</h4>
                </div>
                <div class="table-responsive" id="table-id">
                    <div class="card-datatable table-responsive pt-0" id="violation-registration-register-parent">
                        <table class="violation-registration-register table text-center">
                            <thead class="table-light">
								<tr class="filter-container"></tr>
                                <tr>
                                    <th>ID</th>
                                    <th>Файл</th>
                                    <th>Үүсгэсэн огноо</th>
                                    <th>Ажилтан</th>
                                    <th>Салбар</th>
                                    <th>Үйлдэл</th>
                                </tr>
                            </thead>
							<tfoot>
								<tr>
                                    <th>ID</th>
                                    <th>Файл</th>
                                    <th>Үүсгэсэн огноо</th>
                                    <th>Ажилтан</th>
                                    <th>Салбар</th>
                                    <th>Үйлдэл</th>
                                </tr>
							</tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include "pages/report/violation-registration/registration/form.html" %}
{% include "pages/report/violation-registration/registration/delete-modal.html" %}

{% endblock content %}

{% block js %}

<script src="{% static 'app-assets/vendors/js/file-uploaders/dropzone.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.bootstrap5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/responsive.bootstrap5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/datatables.buttons.min.js' %}"></script>

<script src="{% static 'app-assets/vendors/js/tables/datatable/jszip.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/pdfmake.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/vfs_fonts.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/buttons.html5.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/buttons.print.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/tables/datatable/dataTables.rowGroup.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/forms/cleave/cleave.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/forms/cleave/addons/cleave-phone.us.js' %}"></script>

<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.date.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/picker.time.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/pickadate/legacy.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/pickers/flatpickr/flatpickr.min.js' %}"></script>

<script src="{% static 'app-assets/js/scripts/tables/table-datatables-advanced.js' %}"></script>
<script src="{% static 'app-assets/js/scripts/forms/pickers/form-pickers.js' %}"></script>

<script>

    var removeFiles = []
    var orderFormCreateForm = $("#formEvent")
	var cancelId

    function cancelButtonEvent(id)
	{
		cancelId = id
	}

    /** Tooltip ажиллуулж байна */
    $(document).ready(function() {
        $("body").tooltip({ selector: '[data-toggle=tooltip]' });
    });

    // DATA-TABLE
    const dataTable = $(".violation-registration-register")
		.on('preXhr.dt', function ()
		{
			addLoader($('#violation-registration-register-parent'))
		})
		.on( 'draw.dt', function () {
			rmLoader($('#violation-registration-register-parent'))
        })
		.DataTable({
			processing: false,
			dom: 'lBfrtip',
			serverSide: true,
			ajax: { url: `{% url 'violation-registration-json' %}` },
			columns: [
				{ data: "id" },
				{ data: "file" },
				{ data: "created_at" },
				{ data: "created_at" },
				{ data: "created_at" },
				{ data: "" },
			],
			bFilter: true,
			columnDefs: [
				{
					targets: -1,
					title: "Үйлдэл",
					orderable: false,
					render: function (data, type, full, meta)
					{
						return (
                            `<a
                                data-toggle="tooltip"
                                title="Устгах"
                                data-bs-toggle="modal"
                                data-bs-target="#cancel-modal"
                                class="text-primary-orange delete-record ms-1"
                                onclick="cancelButtonEvent(${full.id})"
                            >
                                ${feather.icons["x-square"].toSvg(
                                {
                                    class: "font-small-4",
                                })}
                            </a>`
                        );
					},
				},
				{
					targets: 0,
					title: "#",
					orderable: false,
					render: function (data, type, full, meta) {
						return (
							meta.settings._iDisplayStart + meta.row + 1
						);
					},
				},
				{
					targets: 1,
                    orderable: false,
					render: function (data, type, full, meta)
					{
						return (
							`<span>
								${full.file_name}
								<a
									data-toggle="tooltip"
									title="Татах"
									href='${full.file}'
									download='${full.file_name}'
								>
								${feather.icons["arrow-down"].toSvg(
								{
									class: "font-medium-2 text-primary",
								})}
								</a>
							</span>`
						)
					},
				},
                {
					targets: 3,
					orderable: false,
					render: function (data, type, full, meta)
					{
						return full.employee.name
					},
				},
                {
					targets: 4,
					orderable: false,
					render: function (data, type, full, meta)
					{
						return full.employee.salbar_name
					},
				},
			],
			initComplete: function()
			{
				rmLoader($('#table-id'))
			},
			order: [[3, "desc"]],
			lengthMenu: [
                [10, 25, 50, 100, -1],
                [10, 25, 50, 100, 'Бүгд'],
            ],
			dom:
				'<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"' +
				'<"col-sm-12 col-lg-4 d-flex justify-content-center justify-content-lg-start" l>' +
				'<"col-sm-12 col-lg-8 ps-xl-75 ps-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1">B>>' +
				">t" +
				'<"d-flex justify-content-between mx-2 row mb-1"' +
				'<"col-sm-12 col-md-6"i>' +
				'<"col-sm-12 col-md-6"p>' +
				">",
			oLanguage: {
				sProcessing: "Ачааллаж байна. ",
				sSearch: "Хайх: ",
				sEmptyTable: "Бичлэг байхгүй",
				sInfoEmpty: "Нийт 0 бичлэг",
				sInfo: "Дэлгэцэнд: _START_ - _END_ Нийт: _TOTAL_ бичлэг",
				sInfoFiltered: " - _MAX_ бичлэгээс",
				sLengthMenu: "_MENU_ бичлэг",
				oPaginate: {
					sFirst: "Эхэнд",
					sLast: "Төгсгөлд",
					sNext: "Дараах",
					sPrevious: "Өмнөх",
				},
			},
			// Buttons with Dropdown
			buttons: [
				{
					extend: "collection",
					className: "btn btn-outline-secondary dropdown-toggle me-2",
					text:
						feather.icons["external-link"].toSvg({
							class: "font-small-4 me-50",
						}) + "Export",
					buttons: [
						{
							extend: "print",
							text:
								feather.icons["printer"].toSvg({
									class: "font-small-4 me-50",
								}) + "Print",
							className: "dropdown-item",
							exportOptions: { columns: [0, 1, 2, 3] },
						},
						{
							extend: "csv",
							text:
								feather.icons["file-text"].toSvg({
									class: "font-small-4 me-50",
								}) + "Csv",
							className: "dropdown-item",
							exportOptions: { columns: [0, 1, 2, 3] },
						},
						{
							extend: "excel",
							text:
								feather.icons["file"].toSvg({
									class: "font-small-4 me-50",
								}) + "Excel",
							className: "dropdown-item",
							exportOptions: { columns: [0, 1, 2, 3] },
						},
						{
							extend: "pdf",
							text:
								feather.icons["clipboard"].toSvg({
									class: "font-small-4 me-50",
								}) + "Pdf",
							className: "dropdown-item",
							exportOptions: { columns: [0, 1, 2, 3] },
						},
						{
							extend: "copy",
							text:
								feather.icons["copy"].toSvg({
									class: "font-small-4 me-50",
								}) + "Copy",
							className: "dropdown-item",
							exportOptions: { columns: [0, 1, 2, 3] },
						},
					],
					init: function (api, node, config) {
						$(node).removeClass("btn-secondary");
						$(node).parent().removeClass("btn-group");
						setTimeout(function () {
							$(node)
								.closest(".dt-buttons")
								.removeClass("btn-group")
								.addClass("d-inline-flex mt-50");
						}, 50);
					},
				},
                {
                    text: "Шинээр бүртгэх",
                    className: "add-new btn btn-primary ",
                    attr: {
                        "data-bs-toggle": "modal",
                        "data-bs-target": "#modals-slide-in",
                        // "onClick": "clearFormDatas()"
                    },
                    init: function (api, node, config) {
                        $(node).removeClass("btn-secondary").addClass('click_btn')

                    },
                }
			],
		});

    async function cancelEvent()
	{
        console.log('cancelId', cancelId)
		useLoader(fetchData(`/report/violation-registration-action/${cancelId}/`, null, 'DELETE'), $(event.target)).catch(err => err)
			.then(
				({ success, data, errors }) =>
				{
					/** Амжилттай болбол Datatable refresh хийж modal-ийг хаана */
					if (success)
					{
						dataTable.ajax.reload()
					}
				}
			)
	}

    let dz = new Dropzone("#dZUpload", {
        url: "/test",
        clickable: true,
        paramName: 'file', // The name that will be used to transfer the file
        autoProcessQueue: false,
        addRemoveLinks: true,
        accept: function(file, done)
        {
            if (file.size > 1*1024*1024) {
                this.removeFile(file);
                alert('Файл хэтэрхий том хэмжээтэй байна!');
                return false;
            }

            $(".dz-progress").remove();
            $(".dz-remove").html(
                `<div><span class='fa fa-trash text-danger'></span></div>`
            );

            if ($('.dz-preview').length == 2)
            {
                $('.dz-preview')[0].remove()
            }

            return file.previewElement.classList.add("dz-success");
        },
        removedfile: function(file)
        {
            //  зөвхөн засаж байгаа үед хуучин байсан зургаас id ийг авна
            file.id && removeFiles.push(file.id)

            $(file.previewElement).remove();
        }
    });

    const handleSubmit = async (e) =>
    {
        e.preventDefault();

        const formData = new FormData(event.target)
        const attachemnts = dz.files.filter(el => !el.cfile)

        for(var i = 0; i < attachemnts.length; i ++) {
            const element = attachemnts[i]
            formData.append("file", element, element.name)
        }

        const { success, errors } = await fetchData(`/report/violation-registration-action/`, formData, 'POST', "", false)
        if (success)
        {
            dataTable.ajax.reload()
            $("#modals-slide-in").modal('hide')
        }
    }

    orderFormCreateForm.on("submit", handleSubmit)

</script>

{% endblock js %}
